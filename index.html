<!DOCTYPE html>
<html>

<head>
    <title>Databenki Group</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="./assets/img/dbfavicon.png">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="./libs/leaflet/leaflet.css">
    <link rel="stylesheet" href="./libs/leaflet/L.Control.Locate.min.css">

    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        body,
        html {
            height: 100%;
            margin: 0;
        }

        #map {
            height: 100vh;
            width: 100vw;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }

        #button-container {
            position: fixed;
            bottom: 15px;
            left: 10px;
            z-index: 1000;
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            gap: 7px;

            background: rgba(3, 41, 90, 0.2);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 8px;
        }

        .btn-icon {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .modal-title {
            font-weight: bold;
        }

        .btn-primary {
            background-color: #0d6efd;
            border: none;
        }

        .custom-div-icon i {
            font-size: 24px;
            color: red;
            text-shadow: 1px 1px 2px black;
        }

        .polygon-area-tooltip {
            background: rgba(0, 123, 255, 0.8);
            color: white;
            font-weight: bold;
            border-radius: 4px;
            padding: 2px 6px;
        }

        .leaflet-popup-content {
            margin: 4px;
            font-size: 13px;
            color: #fff;
            background: #007bff;
            border-radius: 6px;
            text-align: center;
        }

        .leaflet-popup-content-wrapper {
            background: #007bff;
            color: #fff;
            padding: 2px 6px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .leaflet-popup-tip {
            background: #007bff;
        }

        .leaflet-control-layers {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            font-family: Arial, sans-serif;
        }

        .leaflet-control-layers-toggle {
            background-image: url('./assets/img/map-layers-icon2.png') !important;
            background-size: 20px 20px;
        }

        /* Legend Styles */
        .map-legend {
            position: absolute;
            top: 20px;
            z-index: 1000;
            background: rgba(0, 123, 255, 0.8);
            color: white;
            padding: 6px 10px;
            border-radius: 5px;
            font-weight: bold;
            display: block;
        }

        #pins-legend {
            left: 15px;
        }



        #area-legend {
            left: 90px;
            display: none;
            animation: shake 0.5s ease-in-out 3;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            50% {
                transform: translateX(5px);
            }

            75% {
                transform: translateX(-5px);
            }
        }

        @media (max-width: 768px) {
            #button-container {
                left: 0;
                bottom: 5px;
                width: 100%;
                justify-content: space-around;
                gap: 7px;
            }

            #button-container .btn {
                flex: 1;
                border-radius: 0;
            }
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <div id="pins-legend" class="map-legend">
        <i class="bi bi-pin"></i>: <span id="pins-value">0</span>
    </div>

    <!-- Legends -->
    <div id="area-legend" class="map-legend">
        Area: <span id="area-value">0</span> mÂ²
    </div>



    <!-- Button container -->
    <div id="button-container" class="text-center p-3">
        <button id="add-point" class="btn btn-secondary rounded-3 btn-icon">
            <i class="bi bi-pin"></i> Pin
        </button>
        <button id="draw-polygon" class="btn btn-secondary rounded-3 btn-icon">
            <i class="bi bi-vector-pen"></i> Draw
        </button>
        <button id="reset" class="btn btn-danger rounded-3 btn-icon">
            <i class="bi bi-arrow-counterclockwise"></i> Reset
        </button>
        <button id="sendBtn" class="btn btn-primary rounded-3 btn-icon" data-bs-toggle="modal"
            data-bs-target="#formModal">
            <i class="bi bi-send-fill"></i> Send
        </button>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header d-flex justify-content-between">
                    <h5 class="modal-title" id="formModalLabel">Save Your Data</h5>
                    <button type="button" class="btn btn-light rounded-circle float-end" data-bs-dismiss="modal"
                        aria-label="Close">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="detailsForm" novalidate>
                        <div class="mb-3">
                            <label for="name" class="form-label">Full Name</label>
                            <input type="text" id="name" name="name" class="form-control" placeholder="e.g. John Doe"
                                required>
                            <div class="invalid-feedback">Please enter your full name.</div>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" id="phone" name="phone" class="form-control"
                                placeholder="e.g. 255712345678" pattern="^[0-9]{10,12}$" required>
                            <div class="invalid-feedback">Please enter a valid phone number (10-15 digits).</div>
                        </div>
                        <div class="mb-3">
                            <label for="place" class="form-label">Location Name</label>
                            <input type="text" class="form-control" id="place" name="place"
                                placeholder="e.g. Buguruni, Ilala" required>
                            <div class="invalid-feedback">Please enter the place name.</div>
                        </div>
                        <button type="submit" class="btn btn-primary float-end" id="save-data">
                            <i class="bi bi-check-circle-fill"></i> Save Data
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./libs/leaflet/leaflet.js"></script>
    <script src="./libs/leaflet/L.Control.Locate.min.js"></script>
    <script src="./libs/leaflet/L.LatLng.UTM.js"></script>

    <script src="https://unpkg.com/leaflet-path-drag"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        var map = L.map('map', { zoomControl: false }).setView([-6.509, 38.08], 20);

        const osmLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19,
        }).addTo(map);

        const satelliteLayer = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
            attribution: "Tiles &copy; Esri",
            maxZoom: 19,
        });

        const baseLayers = {
            "Street Map": osmLayer,
            "Satellite View": satelliteLayer,
        };
        L.control.layers(baseLayers).addTo(map);

        let currentLatLng = null;
        navigator.geolocation.watchPosition(
            (position) => {
                currentLatLng = L.latLng(
                    position.coords.latitude,
                    position.coords.longitude,
                    position.coords.altitude || null  // altitude as z
                );
                map.setView(currentLatLng, 20);
            },
            (error) => {
                console.error('Geolocation error:', error);
                Swal.fire("Error", "Unable to retrieve your location.", "error");
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );

        L.control.locate({
            position: 'topright',
            drawCircle: true,
            follow: false,
            setView: true,
            keepCurrentZoomLevel: true,
        }).addTo(map);

        L.control.zoom({ position: "topright" }).addTo(map);

        let markers = [];
        let polygon = null;

        function updatePinsLegend() {
            document.getElementById("pins-value").innerText = markers.length;
        }
        updatePinsLegend();

        document.getElementById('add-point').addEventListener('click', () => {
            if (!currentLatLng) {
                Swal.fire("Error", "Unable to get your current location.", "error");
                return;
            }

            let iconHtml = `<i class="bi bi-pin-fill fs-5 text-danger"></i>`;
            let bootstrapIcon = L.divIcon({
                html: iconHtml,
                className: "custom-div-icon",
                iconSize: [24, 24],
                iconAnchor: [12, 24],
            });

            let mcll = L.marker(currentLatLng, { icon: bootstrapIcon, draggable: false })
                .addTo(map)
                .bindPopup(`Corner ${markers.length + 1}`, { offset: L.point(0, -25), closeButton: false })
                .openPopup();

            markers.push(mcll);
            updatePinsLegend();
        });

        document.getElementById('draw-polygon').addEventListener('click', () => {
            if (markers.length < 3) {
                Swal.fire("Warning", "You need at least 3 points to create a polygon.", "warning");
                return;
            }

            let latlngs = markers.map(m => m.getLatLng());
            if (polygon) map.removeLayer(polygon);

            polygon = L.polygon(latlngs, { color: 'blue', fillColor: '#007bff', fillOpacity: 0.3 }).addTo(map);
            updatePolygon();
        });

        function updatePolygon() {
            let latlngs = markers.map(m => m.getLatLng());
            if (polygon) polygon.setLatLngs(latlngs);

            if (polygon) {
                let coords = latlngs.map(ll => [ll.lng, ll.lat]);
                coords.push(coords[0]);
                let area = turf.area(turf.polygon([coords]));
                document.getElementById("area-value").innerText = area.toFixed(2);
                document.getElementById("area-legend").style.display = "block";
            } else {
                document.getElementById("area-legend").style.display = "none";
            }
        }

        document.getElementById('reset').addEventListener('click', () => {
            Swal.fire({
                title: "Are you sure?",
                text: "This will remove all markers and polygons from the map.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes, reset it",
                cancelButtonText: "Cancel"
            }).then((result) => {
                if (result.isConfirmed) {
                    markers.forEach(m => map.removeLayer(m));
                    markers = [];
                    updatePinsLegend();

                    if (polygon) {
                        map.removeLayer(polygon);
                        polygon = null;
                    }
                }
            });
        });


        document.getElementById("detailsForm").addEventListener("submit", function (e) {
            e.preventDefault();

            if (!this.checkValidity()) {
                this.classList.add("was-validated");
                return;
            }

            const name = document.getElementById("name").value;
            const phone = document.getElementById("phone").value;
            const place = document.getElementById("place").value;

            // Convert points to UTM + altitude
            let coordinates = [];
            let latlngs = [];

            if (polygon) {
                latlngs = polygon.getLatLngs()[0];
            } else if (markers.length > 0) {
                latlngs = markers.map(m => m.getLatLng());
            }

            latlngs.forEach(ll => {
                let utmPoint = ll.utm();
                let hemisphere = utmPoint.southHemi ? "Southern" : "Northern";
                let z = (ll.alt !== undefined) ? ll.alt : null;

                coordinates.push({
                    x: utmPoint.x,
                    y: utmPoint.y,
                    z: z,
                    zone: utmPoint.zone,
                    band: utmPoint.band,
                    hemisphere: hemisphere
                });
            });

            const payload = {
                name,
                phone,
                place,
                coordinates   // now an array of JSON objects
            };


            fetch("./submit.php", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire("Success", data.message || "Data submitted successfully!", "success");
                        const modal = bootstrap.Modal.getInstance(document.getElementById("formModal"));
                        modal.hide();
                        this.reset();
                        this.classList.remove("was-validated");


                        markers.forEach(m => map.removeLayer(m));
                        markers = [];
                        updatePinsLegend();

                        if (polygon) {
                            map.removeLayer(polygon);
                            polygon = null;
                        }
                    } else {
                        Swal.fire("Error", data.error || "Something went wrong.", "error");
                    }
                    console.log("Server response:", data);
                })
                .catch(err => {
                    Swal.fire("Error", "Failed to submit data.", "error");
                    console.error(err);
                });
        });
    </script>
</body>

</html>