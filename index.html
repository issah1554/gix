<!DOCTYPE html>
<html>

<head>
    <title>Databenki Group</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="./assets/img/dbfavicon.png">

    <link rel="stylesheet" href="./assets/css/styles.css">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="./libs/leaflet/leaflet.css">
    <link rel="stylesheet" href="./libs/leaflet/L.Control.Locate.min.css">

    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        body,
        html {
            height: 100%;
            margin: 0;
        }

        #map {
            height: 100vh;
            width: 100vw;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }

        #button-container {
            position: fixed;
            bottom: 15px;
            left: 10px;
            z-index: 1000;
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            gap: 7px;

            background: rgba(3, 41, 90, 0.2);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 8px;
        }

        .btn-icon {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .modal-title {
            font-weight: bold;
        }

        .btn-primary {
            background-color: #0d6efd;
            border: none;
        }

        .custom-div-icon i {
            font-size: 24px;
            color: red;
            text-shadow: 1px 1px 2px black;
        }

        .polygon-area-tooltip {
            background: rgba(0, 123, 255, 0.8);
            color: white;
            font-weight: bold;
            border-radius: 4px;
            padding: 2px 6px;
        }

        .leaflet-popup-content {
            margin: 4px;
            font-size: 13px;
            color: #fff;
            background: #007bff;
            border-radius: 6px;
            text-align: center;
        }

        .leaflet-popup-content-wrapper {
            background: #007bff;
            color: #fff;
            padding: 2px 6px;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .leaflet-popup-tip {
            background: #007bff;
        }

        .leaflet-control-layers {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            font-family: Arial, sans-serif;
        }

        .leaflet-control-layers-toggle {
            background-image: url('./assets/img/map-layers-icon2.png') !important;
            background-size: 20px 20px;
        }

        .leaflet-touch .leaflet-control-layers-toggle {
            width: 30px;
            height: 30px;
        }

        .area-control {
            display: none;
            animation: shake 0.5s ease-in-out 3;
        }

        /* Raise above map */
        .leaflet-control .dropdown-menu {
            z-index: 2000;
            /* stay above Leaflet map */
            min-width: 160px;
            border-radius: 6px;
            font-size: 14px;
        }

        /* Full width clickable row */
        .leaflet-control .dropdown-item {
            display: block;
            width: 100%;
            padding: 8px 15px;
            cursor: pointer;
        }

        .leaflet-touch .leaflet-bar a.options-control {
            width: 100% !important;
            height: 100% !important;
            line-height: 20px;
            margin: 0 !important;
        }

        .leaflet-touch .leaflet-bar a.options-control:hover {
            background-color: #a8a9aa !important;
        }

        .leaflet-control .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .leaflet-control .dropdown-menu {
            z-index: 2000;
            min-width: 130px;
            border-radius: 6px;
            font-size: 14px;
            left: 5px;
        }

        .leaflet-top .leaflet-control .leaflet-control-options {
            margin-top: 10px;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            50% {
                transform: translateX(5px);
            }

            75% {
                transform: translateX(-5px);
            }
        }

        @media (max-width: 768px) {
            #button-container {
                left: 0;
                bottom: 5px;
                width: 100%;
                justify-content: space-around;
                gap: 7px;
            }

            #button-container .btn {
                flex: 1;
                border-radius: 0;
            }
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <!-- Button container -->
    <div id="button-container" class="text-center p-3">
        <button id="add-point" class="btn btn-secondary rounded-3 btn-icon">
            <i class="bi bi-pin"></i> Pin
        </button>
        <button id="print-map" class="btn btn-secondary rounded-3 btn-icon">
            <i class="bi bi-printer"></i>Print
        </button>
        <button id="reset" class="btn btn-danger rounded-3 btn-icon">
            <i class="bi bi-arrow-counterclockwise"></i> Reset
        </button>
        <button id="sendBtn" class="btn btn-primary rounded-3 btn-icon" data-bs-toggle="modal"
            data-bs-target="#formModal">
            <i class="bi bi-send-fill"></i> Send
        </button>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header d-flex justify-content-between">
                    <h5 class="modal-title" id="formModalLabel">Save Your Data</h5>
                    <button type="button" class="btn btn-light rounded-circle float-end" data-bs-dismiss="modal"
                        aria-label="Close">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="detailsForm" novalidate>
                        <div class="mb-3">
                            <label for="name" class="form-label">Full Name</label>
                            <input type="text" id="name" name="name" class="form-control" placeholder="e.g. John Doe"
                                required>
                            <div class="invalid-feedback">Please enter your full name.</div>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" id="phone" name="phone" class="form-control"
                                placeholder="e.g. 255712345678" pattern="^[0-9]{10,12}$" required>
                            <div class="invalid-feedback">Please enter a valid phone number (10-15 digits).</div>
                        </div>
                        <div class="mb-3">
                            <label for="place" class="form-label">Location Name</label>
                            <input type="text" class="form-control" id="place" name="place"
                                placeholder="e.g. Buguruni, Ilala" required>
                            <div class="invalid-feedback">Please enter the place name.</div>
                        </div>
                        <button type="submit" class="btn btn-primary float-end" id="save-data">
                            <i class="bi bi-check-circle-fill"></i> Save Data
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./libs/leaflet/leaflet.js"></script>
    <script src="./libs/leaflet/L.Control.Locate.min.js"></script>
    <script src="./libs/leaflet/L.LatLng.UTM.js"></script>

    <script src="https://unpkg.com/leaflet-path-drag"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Leaflet EasyPrint -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easyprint@2.1.9/dist/bundle.min.js"></script>

    <!-- html2canvas (for capturing the map as an image) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>


    <script>
        var map = L.map('map', { zoomControl: false }).setView([-6.509, 38.08], 20);

        const osmLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19,
        }).addTo(map);

        const satelliteLayer = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
            attribution: "Tiles &copy; Esri",
            maxZoom: 19,
        });

        const baseLayers = {
            "Street Map": osmLayer,
            "Satellite View": satelliteLayer,
        };

        // 1. Layers Control
        L.control.layers(baseLayers).addTo(map);

        // 2. Geolocation control
        L.control.locate({
            position: 'topright',
            drawCircle: true,
            follow: false,
            setView: true,
            keepCurrentZoomLevel: true,
        }).addTo(map);
        L.control.zoom({ position: "topright" }).addTo(map);

        let currentLatLng = null;

        // 3. Auto-Center control
        L.Control.ToggleCenter = L.Control.extend({
            onAdd: function (map) {
                let btn = L.DomUtil.create("button", "leaflet-control-centering btn btn-light btn-sm leaflet-control");
                btn.id = "toggle-center";
                btn.innerHTML = '<i class="bi bi-crosshair" style="filter: drop-shadow(0 0 1px);"></i>';
                btn.title = "Toggle Auto Center";

                const updateButton = () => {
                    if (autoCenter) {
                        btn.classList.add("text-primary"); // ON state
                    } else {
                        btn.classList.remove("text-primary"); // OFF state
                    }
                };

                updateButton();

                L.DomEvent.on(btn, "click", L.DomEvent.stopPropagation)
                    .on(btn, "click", L.DomEvent.preventDefault)
                    .on(btn, "click", () => {
                        autoCenter = !autoCenter;
                        updateButton();

                        Swal.fire({
                            icon: "info",
                            title: "Auto Center",
                            text: autoCenter ? "Enabled" : "Disabled",
                            timer: 2000,
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false
                        });
                    });

                return btn;
            },

            onRemove: function (map) { }
        });
        let autoCenter = true;
        let isDragable = false;
        L.control.toggleCenter = function (opts) {
            return new L.Control.ToggleCenter(opts);
        }
        L.control.toggleCenter({ position: "topright" }).addTo(map);


        navigator.geolocation.watchPosition(
            (position) => {
                currentLatLng = L.latLng(
                    position.coords.latitude,
                    position.coords.longitude,
                    position.coords.altitude || null
                );

                if (autoCenter) {
                    map.setView(currentLatLng, map.getZoom());
                }
            },
            (error) => {
                console.error("Geolocation error:", error);
                Swal.fire("Error", "Unable to retrieve your location.", "error");
            },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );

        // 4. Copyright Control
        var CopyrightControl = L.Control.extend({
            options: {
                position: "bottomleft" // typical position for copyright
            },

            onAdd: function (map) {
                var container = L.DomUtil.create("div", "copyright-control");

                // Add copyright HTML
                container.innerHTML = "&copy; 2025 Databenki Group";

                // Styling
                container.style.background = "rgba(255, 255, 255, 0.8)";
                container.style.padding = "3px 6px";
                container.style.borderRadius = "4px";
                container.style.fontSize = "12px";
                container.style.color = "#333";
                container.style.boxShadow = "0 0 3px rgba(0,0,0,0.2)";

                // Prevent map interaction when clicking this control
                L.DomEvent.disableClickPropagation(container);

                return container;
            }
        });
        var copyrightControl = new CopyrightControl();
        copyrightControl.addTo(map);

        // 6. Scale Control
        L.control.scale({
            position: "bottomright", // default is bottomleft
            metric: true,           // show metric units
            imperial: false,        // hide imperial units
            maxWidth: 200           // maximum width of the scale in pixels
        }).addTo(map);

        // 7. Timestamp Controll
        var TimestampControl = L.Control.extend({
            options: { position: "bottomleft" },

            onAdd: function (map) {
                var container = L.DomUtil.create("div", "timestamp-control");

                const now = new Date();
                container.innerHTML = "<small>Printed on: " + now.toLocaleString() + "</small>";

                container.style.background = "white";
                container.style.display = "none";
                container.style.padding = "3px 6px";
                container.style.borderRadius = "4px";
                container.style.fontSize = "12px";
                container.style.color = "#333";
                container.style.boxShadow = "0 0 3px rgba(0,0,0,0.2)";

                L.DomEvent.disableClickPropagation(container);
                return container;
            }
        });
        var timestampControl = new TimestampControl();
        timestampControl.addTo(map);


        // 8. Corner + Area Control
        var CombinedControl = L.Control.extend({
            options: { position: "topleft" },
            onAdd: function (map) {
                var container = L.DomUtil.create("div", "combined-control");
                container.style.display = "flex";
                container.style.gap = "5px";

                var cornersDiv = L.DomUtil.create("div", "corners-control", container);
                cornersDiv.innerHTML = "<small style='font-size:14px; font-weight:bold;'>Corners: 0</small>";
                cornersDiv.style.background = "rgba(0, 123, 255, 0.8)";
                cornersDiv.style.color = "white";
                cornersDiv.style.padding = "7px";
                cornersDiv.style.borderRadius = "4px";
                cornersDiv.style.boxShadow = "0 0 3px rgba(0,0,0,0.2)";
                cornersDiv.id = "corners-control";


                var areaDiv = L.DomUtil.create("div", "area-control", container);
                areaDiv.innerHTML = "<small style='font-size:14px; font-weight:bold;'>Area Covered: 00.00 mÂ²</small>";
                areaDiv.style.background = "rgba(0, 123, 255, 0.8)";
                areaDiv.style.padding = "7px";
                areaDiv.style.color = "white";
                areaDiv.style.borderRadius = "4px";
                areaDiv.style.boxShadow = "0 0 3px rgba(0,0,0,0.2)";
                areaDiv.id = "area-control";

                L.DomEvent.disableClickPropagation(container);

                return container;
            }
        });
        map.addControl(new CombinedControl());


        let markers = [];
        let polygon = null;

        function updateCornersCount() {
            let smallTag = document.querySelector(".corners-control small");
            if (smallTag) {
                smallTag.innerText = `Corners: ${markers.length}`;
            }
        }
        updateCornersCount();

        document.getElementById('add-point').addEventListener('click', () => {
            if (!currentLatLng) {
                Swal.fire("Error", "Unable to get your current location.", "error");
                return;
            }

            let bootstrapIcon = L.icon({
                iconUrl: './assets/img/pin-icon5.png', // ðŸ”¹ path to your PNG
                iconSize: [38, 38],               // size of the icon in pixels
                iconAnchor: [19, 38],             // point of the icon which will correspond to marker's location
                popupAnchor: [0, -4],             // where popups should open relative to icon
                className: "hide-on-print" // custom class

            });


            let mcll = L.marker(currentLatLng, { icon: bootstrapIcon, draggable: isDragable })
                .addTo(map)
                .bindPopup(`Corner ${markers.length + 1}`, { offset: L.point(0, -25), closeButton: false })
                .openPopup();

            mcll.on("drag", updatePolygon);
            mcll.on("dragend", updatePolygon);

            markers.push(mcll);
            updateCornersCount();

            updatePolygon(); // update polygon immediately after adding marker

        });


        // 4. Options control
        L.Control.OptionsMenu = L.Control.extend({
            onAdd: function (map) {
                // Container
                let container = L.DomUtil.create("div", "leaflet-control leaflet-bar leaflet-control-options");

                // Wrapper for bootstrap dropdown
                let wrapper = L.DomUtil.create("div", "dropdown", container);

                // Button
                let btn = L.DomUtil.create("button", "btn btn-light btn-sm", wrapper);
                btn.id = "optionsMenu";
                btn.setAttribute("data-bs-toggle", "dropdown");
                btn.setAttribute("aria-expanded", "false");
                btn.innerHTML = '<i class="bi bi-three-dots-vertical"></i>';

                // Dropdown menu
                let menu = L.DomUtil.create("ul", "dropdown-menu dropdown-menu-end shadow-sm", wrapper);
                menu.setAttribute("aria-labelledby", "optionsMenu");

                // Menu items
                menu.innerHTML = `
                    <li><a class="dropdown-item options-control px-0" href="#" id="option1"><i class="bi bi-check2-square text-primary  me-2"></i>Show marker</a></li>
                    <li><a class="dropdown-item options-control px-0" href="#" id="option2">Option 2</a></li>
                    <li><a class="dropdown-item options-control px-0" href="#" id="option3">Option 3</a></li>
                `;

                // Track state outside the handler
                let markersVisible = true;

                menu.querySelector("#option1").addEventListener("click", (e) => {
                    e.preventDefault();

                    if (markersVisible) {
                        // Hide all markers
                        markers.forEach(m => map.removeLayer(m));
                        markersVisible = false;
                        // Change icon/text
                        e.target.innerHTML = 'Show markers';

                    } else {
                        // Show all markers
                        markers.forEach(m => m.addTo(map));
                        markersVisible = true;
                        // Change icon/text
                        e.target.innerHTML = '<i class="bi bi-check2-square me-2 text-primary"></i>Show markers';

                    }
                });

                menu.querySelector("#option2").addEventListener("click", () => Swal.fire("Option 2 clicked"));
                menu.querySelector("#option3").addEventListener("click", () => Swal.fire("Option 3 clicked"));

                return container;
            },
            onRemove: function (map) { }
        });

        // Register and add
        L.control.optionsMenu = function (opts) {
            return new L.Control.OptionsMenu(opts);
        }
        L.control.optionsMenu({ position: "topright" }).addTo(map);
        
        //Print Map Control with Leaflet.EasyPrint
        var printer = L.easyPrint({
            title: 'Print / Save Map',
            position: 'topright',
            sizeModes: ['Current'],
            exportOnly: false,
            hideControlContainer: false,
            hideClasses: [
                'leaflet-control-zoom',
                'leaflet-control-locate',
                'leaflet-control-layers',
                'leaflet-control-centering',
                'leaflet-control-options'
            ],
            filename: 'MyMapExport',
            tileWait: 1000,
            hidden: true  // âŒ hides default button
        }).addTo(map);

        document.getElementById('print-map').addEventListener('click', () => {
            markers.forEach(m => map.removeLayer(m));
            printer.printMap('CurrentSize', 'MyMapExport');
        });

        function updatePolygon() {
            let latlngs = markers.map(m => m.getLatLng());
            if (latlngs.length < 3) {
                if (polygon) {
                    map.removeLayer(polygon);
                    polygon = null;
                }
                document.getElementById("area-control").style.display = "none";
                return;
            }

            if (!polygon) {
                polygon = L.polygon(latlngs, {
                    color: 'blue',
                    fillColor: '#007bff',
                    fillOpacity: 0.3
                }).addTo(map);
            } else {
                polygon.setLatLngs(latlngs);
            }

            let coords = latlngs.map(ll => [ll.lng, ll.lat]);
            coords.push(coords[0]);
            let area = turf.area(turf.polygon([coords]));

            document.getElementById("area-control").style.display = "block";

            // FIXED: Update the <small> inside area-control
            let smallTag = document.querySelector(".area-control small");
            if (smallTag) {
                smallTag.innerText = `Total Area: ${area.toFixed(2)} mÂ²`;
            }
        }

        document.getElementById('reset').addEventListener('click', () => {
            Swal.fire({
                title: "Are you sure?",
                text: "This will remove all markers and polygons from the map.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes, reset it",
                cancelButtonText: "Cancel"
            }).then((result) => {
                if (result.isConfirmed) {
                    markers.forEach(m => map.removeLayer(m));
                    markers = [];
                    document.getElementById("area-control").style.display = "none";
                    updateCornersCount();

                    if (polygon) {
                        map.removeLayer(polygon);
                        polygon = null;
                    }
                }
            });
        });


        let clickCount = 0;
        let timerId = null;
        const cornersControl = document.getElementById("corners-control");
        function handleClick() {
            if (timerId) { clearTimeout(timerId); }
            clickCount++;
            console.log(clickCount);
            if (clickCount === 9) {
                isDragable = !isDragable;
                Swal.fire({
                    icon: "info",
                    title: "Dragging",
                    text: isDragable ? "Enabled" : "Disabled",
                    timer: 2000,
                    toast: true,
                    position: "top-end",
                    showConfirmButton: false
                });
                clickCount = 0;
            }
            timerId = setTimeout(() => {
                clickCount = 0;
            }, 1000);
        }
        cornersControl.addEventListener("click", handleClick);
        document.addEventListener("click", (e) => {
            if (!cornersControl.contains(e.target)) {
                clickCount = 0;
                if (timerId) {
                    clearTimeout(timerId);
                    timerId = null;
                }
            }
        });


        document.getElementById("detailsForm").addEventListener("submit", function (e) {
            e.preventDefault();

            if (!this.checkValidity()) {
                this.classList.add("was-validated");
                return;
            }

            const name = document.getElementById("name").value;
            const phone = document.getElementById("phone").value;
            const place = document.getElementById("place").value;

            // Convert points to UTM + altitude
            let coordinates = [];
            let latlngs = [];

            if (polygon) {
                latlngs = polygon.getLatLngs()[0];
            } else if (markers.length > 0) {
                latlngs = markers.map(m => m.getLatLng());
            }

            latlngs.forEach(ll => {
                let utmPoint = ll.utm();
                let hemisphere = utmPoint.southHemi ? "Southern" : "Northern";
                let z = (ll.alt !== undefined) ? ll.alt : null;

                coordinates.push({
                    x: utmPoint.x,
                    y: utmPoint.y,
                    z: z,
                    zone: utmPoint.zone,
                    band: utmPoint.band,
                    hemisphere: hemisphere
                });
            });

            const payload = {
                name,
                phone,
                place,
                coordinates   // now an array of JSON objects
            };


            fetch("/ardhi/api/submit", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire("Success", data.message || "Data submitted successfully!", "success");
                        const modal = bootstrap.Modal.getInstance(document.getElementById("formModal"));
                        modal.hide();
                        this.reset();
                        this.classList.remove("was-validated");


                        markers.forEach(m => map.removeLayer(m));
                        markers = [];
                        updateCornersCount();

                        if (polygon) {
                            map.removeLayer(polygon);
                            polygon = null;
                        }
                    } else {
                        Swal.fire("Error", data.error || "Something went wrong.", "error");
                    }
                    console.log("Server response:", data);
                })
                .catch(err => {
                    Swal.fire("Error", "Failed to submit data.", "error");
                    console.error(err);
                });
        });
    </script>
</body>

</html>