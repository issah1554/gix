<!DOCTYPE html>
<html>

<head>
    <title>Databenki GPS</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="./libs/leaflet/leaflet.css">
    <link rel="stylesheet" href="./libs/leaflet/L.Control.Locate.min.css">

    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <style>
        body,
        html {
            height: 100%;
            margin: 0;
        }

        #map {
            height: 100vh;
            width: 100vw;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }

        #button-container {
            position: absolute;
            bottom: 15px;
            left: 15px;
            z-index: 1000;
            display: flex;
            flex-wrap: wrap;

            background: rgba(255, 255, 255, 0.2);
            /* light transparent background */
            backdrop-filter: blur(2px);
            /* frosted glass effect */
            -webkit-backdrop-filter: blur(10px);
            /* for Safari */
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }


        .btn-icon {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .modal-title {
            font-weight: bold;
        }

        .btn-primary {
            background-color: #0d6efd;
            border: none;
        }

        .custom-div-icon i {
            font-size: 24px;
            color: red;
            text-shadow: 1px 1px 2px black;
        }

        .polygon-area-tooltip {
            background: rgba(0, 123, 255, 0.8);
            color: white;
            font-weight: bold;
            border-radius: 4px;
            padding: 2px 6px;
        }

        .leaflet-popup-content {
            margin: 4px;
            /* reduce padding inside popup */
            font-size: 13px;
            /* smaller text */
            color: #fff;
            /* text color */
            background: #007bff;
            /* custom background */
            border-radius: 6px;
            text-align: center;
        }

        .leaflet-popup-content-wrapper {
            background: #007bff;
            /* match wrapper background */
            color: #fff;
            padding: 2px 6px;
            /* tight padding */
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        .leaflet-popup-tip {
            background: #007bff;
            /* arrow color */
        }

        .leaflet-control-layers {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            font-family: Arial, sans-serif;
        }

        .leaflet-control-layers-toggle {
            background-image: url('./assets/img/map-layers-icon.png');
            background-size: 20px 20px;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <div id="area-legend" style="
    position: absolute;
    top: 20px;
    left: 15px;
    z-index: 1000;
    background: rgba(0,123,255,0.8);
    color: white;
    padding: 6px 10px;
    border-radius: 5px;
    font-weight: bold;
    display: none;
">
        Area: <span id="area-value">0</span> m²
    </div>

    <div id="button-container" class="row text-center">
        <div class="col-auto">
            <button id="add-point" class="btn btn-secondary rounded-3 btn-icon">
                <i class="bi bi-pin"></i> Pin
            </button>
        </div>
        <div class="col-auto">
            <button id="draw-polygon" class="btn btn-secondary rounded-3 btn-icon">
                <i class="bi bi-vector-pen"></i> Draw
            </button>
        </div>

        <div class="col-auto">
            <button id="reset" class="btn btn-danger rounded-3 btn-icon">
                <i class="bi bi-arrow-counterclockwise"></i> Reset
            </button>
        </div>
        <div class="col-auto">
            <button id="sendBtn" class="btn btn-primary rounded-3 btn-icon" data-bs-toggle="modal"
                data-bs-target="#formModal">
                <i class="bi bi-send-fill"></i> Send
            </button>
        </div>

    </div>

    <!-- Modal -->
    <div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header d-flex justify-content-between">
                    <h5 class="modal-title" id="formModalLabel">Submit Your Details</h5>
                    <button type="button" class="btn btn-light rounded-circle float-end" data-bs-dismiss="modal" aria-label="Close">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="detailsForm" novalidate>
                        <div class="mb-3">
                            <label for="name" class="form-label">Full Name</label>
                            <input type="text" id="name" name="name" class="form-control"
                                placeholder="Enter your full name" required>
                            <div class="invalid-feedback">Please enter your full name.</div>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" id="phone" name="phone" class="form-control"
                                placeholder="Enter your phone number" pattern="^[0-9]{10,15}$" required>
                            <div class="invalid-feedback">Please enter a valid phone number (10-15 digits).</div>
                        </div>
                        <div class="mb-3">
                            <label for="place" class="form-label">Place Name</label>
                            <input type="text" class="form-control" id="place" name="place"
                                placeholder="Enter the place name" required>
                            <div class="invalid-feedback">Please enter the place name.</div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="save-data">
                            <i class="bi bi-check-circle-fill"></i> Save Data
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="./libs/leaflet/leaflet.js"></script>
    <script src="./libs/leaflet/L.Control.Locate.min.js"></script>
    <script src="./libs/leaflet/L.LatLng.UTM.js"></script>

    <!-- Leaflet plugins -->
    <script src="https://unpkg.com/leaflet-path-drag"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        var map = L.map('map', { zoomControl: false }).setView([-6.509, 38.08], 20);

        // ───────────────
        // Base Layers
        // ───────────────
        const osmLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 19,
        });
        osmLayer.addTo(map);

        const satelliteLayer = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", {
            attribution: "Tiles &copy; Esri",
            maxZoom: 19,
        });

        const cartoLightLayer = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png", {
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
            maxZoom: 20,
        });

        const baseLayers = {
            "Street Map": osmLayer,
            "Satellite View": satelliteLayer,
            "Carto Light": cartoLightLayer,
        };
        L.control.layers(baseLayers).addTo(map);

        // ───────────────
        // Locate control
        // ───────────────
        let currentLatLng = null;
        navigator.geolocation.watchPosition(
            (position) => {
                currentLatLng = [position.coords.latitude, position.coords.longitude];
                map.setView(currentLatLng, 20);
            },
            (error) => {
                console.error('Geolocation error:', error);
                Swal.fire("Error", "Unable to retrieve your location.", "error");
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
        );

        L.control.locate({
            position: 'topright',
            drawCircle: true,
            follow: false,
            setView: true,
            keepCurrentZoomLevel: true,
        }).addTo(map);

        L.control
            .zoom({
                position: "topright",
                zoomInText: "+",
                zoomOutText: "-",
                zoomInTitle: "Zoom in",
                zoomOutTitle: "Zoom out",
            })
            .addTo(map);

        // ───────────────
        // Variables
        // ───────────────
        let markers = [];
        let polygon = null;
        let areaVisible = true;

        // ───────────────
        // Add draggable marker
        // ───────────────
        document.getElementById('add-point').addEventListener('click', () => {
            if (!currentLatLng) {
                Swal.fire("Error", "Unable to get your current location.", "error");
                return;
            }

            let iconHtml = `<i class="bi bi-pin-fill fs-5 text-danger"></i>`;
            let bootstrapIcon = L.divIcon({
                html: iconHtml,
                className: "custom-div-icon",
                iconSize: [24, 24],
                iconAnchor: [12, 24], // bottom center, so it sits on polygon
            });

            let mcll = L.marker(currentLatLng, { icon: bootstrapIcon, draggable: true })
                .addTo(map)
                .bindPopup(`Corner ${markers.length + 1}`, {
                    offset: L.point(0, -25), // float above marker
                    closeButton: false,
                    autoPan: false
                })
                .openPopup();

            markers.push(mcll);

            mcll.on('drag', () => {
                if (polygon) updatePolygon();
            });
        });


        // ───────────────
        // Draw polygon
        // ───────────────
        document.getElementById('draw-polygon').addEventListener('click', () => {
            if (markers.length < 3) {
                Swal.fire("Warning", "You need at least 3 points to create a polygon.", "warning");
                return;
            }

            let latlngs = markers.map(m => m.getLatLng());

            if (polygon) {
                map.removeLayer(polygon);
                polygon = null;
            }

            polygon = L.polygon(latlngs, {
                color: 'blue',
                fillColor: '#007bff',
                fillOpacity: 0.3,
                draggable: false
            }).addTo(map);

            updatePolygon();

            polygon.on('drag', () => {
                let newLatLngs = polygon.getLatLngs()[0];
                let deltaLat = newLatLngs[0].lat - latlngs[0].lat;
                let deltaLng = newLatLngs[0].lng - latlngs[0].lng;

                markers.forEach((m) => {
                    let newLat = m.getLatLng().lat + deltaLat;
                    let newLng = m.getLatLng().lng + deltaLng;
                    m.setLatLng([newLat, newLng]);
                });

                updatePolygon();
            });

        });

        function updatePolygon() {
            let latlngs = markers.map(m => m.getLatLng());
            if (polygon) polygon.setLatLngs(latlngs);

            if (polygon) {
                // Calculate area
                let coords = latlngs.map(ll => [ll.lng, ll.lat]);
                coords.push(coords[0]); // close polygon
                let area = turf.area(turf.polygon([coords]));

                // Update legend
                document.getElementById("area-value").innerText = area.toFixed(2);
                document.getElementById("area-legend").style.display = "block";

                // Optional: keep tooltip too
                let centroid = turf.centroid(turf.polygon([coords]));
                let centroidLatLng = [centroid.geometry.coordinates[1], centroid.geometry.coordinates[0]];

            } else {
                document.getElementById("area-legend").style.display = "none";
            }
        }




        // ───────────────
        // Reset button
        // ───────────────
        document.getElementById('reset').addEventListener('click', () => {
            Swal.fire({
                title: "Are you sure?",
                text: "This will remove all markers and polygons from the map.",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes, reset it",
                cancelButtonText: "Cancel"
            }).then((result) => {
                if (result.isConfirmed) {
                    markers.forEach(m => map.removeLayer(m));
                    markers = [];

                    if (polygon) {
                        map.removeLayer(polygon);
                        polygon = null;
                    }
                }
            });
        });


        // ───────────────
        // Save data
        // ───────────────
        document.getElementById('save-data').addEventListener('click', (event) => {
            event.preventDefault();
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const place = document.getElementById('place').value;

            if (!name || !phone || !place) {
                Swal.fire("Error", "Please provide client details.", "error");
                return;
            }

            if (markers.length < 1) {
                Swal.fire("Error", "At least 1 point is needed to save.", "error");
                return;
            }

            let cornerpoints_inUTM = markers.map(m => {
                let cll_utm = m.getLatLng().utm();
                let hemisphere = cll_utm.southHemi ? "Southern" : "Northern";
                return [cll_utm.x, cll_utm.y, cll_utm.zone, cll_utm.band, hemisphere];
            });

            const data = { name, phone, place, cornerpoints_inUTM };
            console.log(data);

            fetch('#', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            })
                .then(response => response.json())
                .then(result => Swal.fire(result.success ? "Success" : "Error", result.message, result.success ? "success" : "error"))
                .catch(error => Swal.fire("Error", "Failed to save data.", "error"));
        });

        document.getElementById('detailsForm').addEventListener('submit', function (event) {
            if (!this.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                Swal.fire("Error", "Please correct the highlighted fields.", "error");
            }
            this.classList.add('was-validated');
        });
    </script>
</body>

</html>